<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoIP Learning Platform</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    .header { background: #2c3e50; color: white; padding: 1em; text-align: center; }
    .tabs { display: flex; background: #34495e; }
    .tab { flex: 1; padding: 1em; background: #34495e; color: white; border: none; cursor: pointer; }
    .tab.active { background: #3498db; }
    .tab:hover { background: #2980b9; }
    .content { padding: 2em; display: none; }
    .content.active { display: block; }
    #log { background: #f4f4f4; padding: 1em; height: 200px; overflow-y: auto; border: 1px solid #ccc; }
    input, button { margin: 0.5em 0; padding: 0.5em; }
    button { background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #2980b9; }
    .call-flow { margin: 2em 0; }
    .flow-line { display: flex; align-items: center; margin: 0.5em 0; }
    .client, .server { width: 100px; text-align: center; font-weight: bold; }
    .arrow { flex: 1; text-align: center; }
    .message { background: #e3f2fd; padding: 0.5em; border-radius: 4px; margin: 0 1em; }
    .message.sent { background: #c8e6c9; }
    .message.received { background: #2196f3; }
    .message.pending { background: #fff3e0; opacity: 0.6; }
    .timeline { font-size: 0.8em; color: #666; }
    .guide-section { margin: 2em 0; }
    .guide-section h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 0.5em; }
    .code-block { background: #f8f9fa; padding: 1em; border-left: 4px solid #3498db; margin: 1em 0; font-family: monospace; }
    .highlight { background: #fff3cd; padding: 0.2em 0.4em; border-radius: 3px; }
    .exercise { background: #e8f5e8; padding: 1em; border-left: 4px solid #28a745; margin: 1em 0; }
    .exercise h4 { color: #28a745; margin-top: 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé§ VoIP Learning Platform</h1>
    <p>Learn Voice over IP internals through interactive demos and visualizations</p>
  </div>
  
  <div class="tabs">
    <button class="tab active" onclick="showTab('demo')">üìû Interactive Demo</button>
    <button class="tab" onclick="showTab('guide')">üìö Learning Guide</button>
    <button class="tab" onclick="showTab('flow')">üîÑ Call Flow</button>
    <button class="tab" onclick="showTab('why')">ü§î Why use VoIP?</button>
    <button class="tab" onclick="showTab('security')">üîí VoIP Security</button>
  </div>

  <!-- Demo Tab -->
  <div id="demo" class="content active">
    <h2>VoIP Client Demo</h2>
    
    <div style="display: flex; gap: 2em;">
      <!-- Left side: Controls -->
      <div style="flex: 1;">
        <h3>Controls</h3>
        <div>
          <label>Username: <input id="username" value="alice"></label>
          <button onclick="registerUser()">Register</button>
        </div>
        <div>
          <label>Call User: <input id="target" value="bob"></label>
          <button onclick="makeCall()">Call</button>
          <button onclick="hangupCall()">Hang Up</button>
          <button onclick="resetDemoCallFlow()" style="background: #e74c3c;">Reset Flow</button>
        </div>
        
        <!-- Audio Controls -->
        <h3>üé§ Audio Controls</h3>
        <div>
          <button id="micButton" onclick="toggleMicrophone()" style="background: #e74c3c;">üé§ Enable Microphone</button>
          <button id="audioButton" onclick="toggleAudioPlayback()" style="background: #e74c3c;" disabled>üîä Enable Audio</button>
        </div>
        <div style="margin-top: 1em;">
          <label>Volume: <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="updateVolume()"></label>
          <span id="volumeValue">50%</span>
        </div>
        <div style="margin-top: 1em;">
          <label>Codec: 
            <select id="codecSelect" onchange="changeCodec()">
              <option value="g711">G.711 (64 kbps)</option>
              <option value="g729">G.729 (8 kbps)</option>
              <option value="opus">Opus (32 kbps)</option>
            </select>
          </label>
        </div>
        
        <h3>Status</h3>
        <div id="status">Not registered</div>
        <h3>Log</h3>
        <div id="log"></div>
      </div>
      
      <!-- Right side: Call Flow Diagram -->
      <div style="flex: 1;">
        <h3>Live Call Flow</h3>
        <p>Watch the SIP messages flow in real-time as you interact!</p>
        
        <div id="demoCallFlow" class="call-flow">
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üí</div>
            <div class="message pending" id="demo-register">REGISTER</div>
            <div class="arrow">‚Üí</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üê</div>
            <div class="message pending" id="demo-register-ok">200 OK</div>
            <div class="arrow">‚Üê</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üí</div>
            <div class="message pending" id="demo-invite">INVITE</div>
            <div class="arrow">‚Üí</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üê</div>
            <div class="message pending" id="demo-trying">100 Trying</div>
            <div class="arrow">‚Üê</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üê</div>
            <div class="message pending" id="demo-ringing">180 Ringing</div>
            <div class="arrow">‚Üê</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üê</div>
            <div class="message pending" id="demo-ok">200 OK</div>
            <div class="arrow">‚Üê</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üí</div>
            <div class="message pending" id="demo-ack">ACK</div>
            <div class="arrow">‚Üí</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üí</div>
            <div class="message pending" id="demo-bye">BYE</div>
            <div class="arrow">‚Üí</div>
            <div class="server">Server</div>
          </div>
          <div class="flow-line">
            <div class="client">Client</div>
            <div class="arrow">‚Üê</div>
            <div class="message pending" id="demo-bye-ok">200 OK</div>
            <div class="arrow">‚Üê</div>
            <div class="server">Server</div>
          </div>
        </div>

        <div class="exercise" style="margin-top: 1em;">
          <h4>Message Status Legend</h4>
          <ul style="list-style: none; padding: 0;">
            <li><span style="background: #fff3e0; padding: 0.2em 0.4em; border-radius: 3px;">Gray</span> = Pending</li>
            <li><span style="background: #c8e6c9; padding: 0.2em 0.4em; border-radius: 3px;">Green</span> = Sent ‚úì</li>
            <li><span style="background: #2196f3; padding: 0.2em 0.4em; border-radius: 3px;">Blue</span> = Received ‚úì</li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- Audio Visualization Section -->
    <div style="margin-top: 2em; border-top: 2px solid #3498db; padding-top: 1em;">
      <h3>üéµ Real-time Audio Visualization</h3>
      
      <div style="display: flex; gap: 2em;">
        <!-- Audio Waveform -->
        <div style="flex: 1;">
          <h4>üìä Audio Waveform</h4>
          <canvas id="waveformCanvas" width="400" height="150" style="border: 1px solid #ccc; background: #f8f9fa;"></canvas>
          <div style="margin-top: 0.5em; font-size: 0.9em; color: #666;">
            <span id="audioLevel">Level: 0%</span> | 
            <span id="frequency">Freq: -- Hz</span> | 
            <span id="packetRate">RTP: 0 pkts/s</span>
          </div>
        </div>
        
        <!-- RTP Packet Monitor -->
        <div style="flex: 1;">
          <h4>üì¶ RTP Packet Monitor</h4>
          <div id="rtpMonitor" style="height: 150px; border: 1px solid #ccc; background: #f8f9fa; overflow-y: auto; padding: 0.5em; font-family: monospace; font-size: 0.8em;">
            <div style="color: #666;">Waiting for audio data...</div>
          </div>
        </div>
      </div>
      
      <!-- Audio Statistics -->
      <div style="margin-top: 1em; display: flex; gap: 2em;">
        <div style="flex: 1;">
          <h4>üìà Call Statistics</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1em;">
            <div>
              <strong>Packets Sent:</strong> <span id="packetsSent">0</span>
            </div>
            <div>
              <strong>Packets Received:</strong> <span id="packetsReceived">0</span>
            </div>
            <div>
              <strong>Packet Loss:</strong> <span id="packetLoss">0%</span>
            </div>
            <div>
              <strong>Jitter:</strong> <span id="jitter">0ms</span>
            </div>
            <div>
              <strong>Bandwidth:</strong> <span id="bandwidth">0 kbps</span>
            </div>
            <div>
              <strong>MOS Score:</strong> <span id="mosScore">--</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Learning Guide Tab -->
  <div id="guide" class="content">
    <h2>VoIP Learning Guide</h2>
    
    <div class="guide-section">
      <h3>What is VoIP?</h3>
      <p>Voice over IP (VoIP) is a technology that allows voice communication over IP networks. Unlike traditional circuit-switched telephony, VoIP uses packet-switched networks, which offers several advantages:</p>
      <ul>
        <li><strong>Cost Efficiency:</strong> Uses existing IP infrastructure</li>
        <li><strong>Flexibility:</strong> Supports various media types (voice, video, data)</li>
        <li><strong>Scalability:</strong> Easy to add new features and users</li>
        <li><strong>Integration:</strong> Can integrate with other IP-based services</li>
      </ul>
    </div>

    <div class="guide-section">
      <h3>Key Components</h3>
      <ol>
        <li><strong>SIP (Session Initiation Protocol):</strong> Signaling protocol for call setup/teardown</li>
        <li><strong>RTP (Real-time Transport Protocol):</strong> Media streaming protocol</li>
        <li><strong>Audio Codecs:</strong> Compression algorithms for efficient bandwidth usage</li>
        <li><strong>Network Transport:</strong> UDP/TCP for packet delivery</li>
      </ol>
    </div>

    <div class="guide-section">
      <h3>SIP Protocol Deep Dive</h3>
      <p>SIP is the signaling protocol used to establish, modify, and terminate multimedia sessions.</p>
      
      <h4>SIP Message Structure</h4>
      <div class="code-block">
SIP/2.0 200 OK                    # Status line (response)
Via: SIP/2.0/UDP 192.168.1.100    # Headers
From: &lt;sip:alice@example.com&gt;
To: &lt;sip:bob@example.com&gt;
Call-ID: abc123@192.168.1.100
CSeq: 1 INVITE
Content-Length: 0

# Empty line separates headers from body
# Message body (optional)
      </div>

      <h4>SIP Methods</h4>
      <ul>
        <li><span class="highlight">INVITE:</span> Initiate a call</li>
        <li><span class="highlight">ACK:</span> Confirm call establishment</li>
        <li><span class="highlight">BYE:</span> Terminate a call</li>
        <li><span class="highlight">CANCEL:</span> Cancel a pending request</li>
        <li><span class="highlight">REGISTER:</span> Register with a server</li>
        <li><span class="highlight">OPTIONS:</span> Query server capabilities</li>
      </ul>

      <h4>SIP Responses</h4>
      <ul>
        <li><span class="highlight">1xx:</span> Provisional (100 Trying, 180 Ringing)</li>
        <li><span class="highlight">2xx:</span> Success (200 OK)</li>
        <li><span class="highlight">3xx:</span> Redirection (302 Moved Temporarily)</li>
        <li><span class="highlight">4xx:</span> Client Error (404 Not Found, 486 Busy)</li>
        <li><span class="highlight">5xx:</span> Server Error (500 Internal Server Error)</li>
        <li><span class="highlight">6xx:</span> Global Failure (600 Busy Everywhere)</li>
      </ul>
    </div>

    <div class="guide-section">
      <h3>RTP Media Streaming</h3>
      <p>RTP (Real-time Transport Protocol) is used for delivering audio and video over IP networks.</p>
      
      <h4>RTP Packet Structure</h4>
      <div class="code-block">
RTP Header (12 bytes):
+----------------+----------------+
| V=2 |P|X|  CC   |M|     PT      |
+----------------+----------------+
|        sequence number          |
+----------------+----------------+
|           timestamp             |
+----------------+----------------+
|           synchronization source identifier (SSRC)  |
+----------------+----------------+
|            contributing source (CSRC) identifiers   |
|                             ....                    |
+----------------+----------------+
|                payload                               |
+----------------+----------------+
      </div>

      <h4>Key RTP Concepts</h4>
      <ol>
        <li><strong>Sequence Numbers:</strong> Detect packet loss and reordering</li>
        <li><strong>Timestamps:</strong> Synchronize audio playback</li>
        <li><strong>SSRC:</strong> Identify the source of the stream</li>
        <li><strong>Payload Type:</strong> Indicate the codec being used</li>
        <li><strong>Marker Bit:</strong> Indicate frame boundaries</li>
      </ol>
    </div>

    <div class="guide-section">
      <h3>Audio Codecs</h3>
      <p>Audio codecs compress audio data to reduce bandwidth usage.</p>
      
      <h4>G.711 Codec</h4>
      <ul>
        <li><strong>Bit Rate:</strong> 64 kbps</li>
        <li><strong>Sample Rate:</strong> 8 kHz</li>
        <li><strong>Compression:</strong> 2:1 (16-bit PCM ‚Üí 8-bit)</li>
        <li><strong>Quality:</strong> Good for voice</li>
        <li><strong>Complexity:</strong> Low</li>
      </ul>

      <h4>Codec Comparison</h4>
      <table style="width: 100%; border-collapse: collapse;">
        <tr style="background: #f8f9fa;">
          <th style="border: 1px solid #ddd; padding: 8px;">Codec</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Bit Rate</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Quality</th>
          <th style="border: 1px solid #ddd; padding: 8px;">Use Case</th>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;">G.711</td>
          <td style="border: 1px solid #ddd; padding: 8px;">64 kbps</td>
          <td style="border: 1px solid #ddd; padding: 8px;">Good</td>
          <td style="border: 1px solid #ddd; padding: 8px;">Traditional VoIP</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;">G.729</td>
          <td style="border: 1px solid #ddd; padding: 8px;">8 kbps</td>
          <td style="border: 1px solid #ddd; padding: 8px;">Good</td>
          <td style="border: 1px solid #ddd; padding: 8px;">Bandwidth-constrained</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;">Opus</td>
          <td style="border: 1px solid #ddd; padding: 8px;">6-510 kbps</td>
          <td style="border: 1px solid #ddd; padding: 8px;">Excellent</td>
          <td style="border: 1px solid #ddd; padding: 8px;">Modern applications</td>
        </tr>
      </table>
    </div>

    <div class="guide-section">
      <h3>Hands-on Exercises</h3>
      
      <div class="exercise">
        <h4>Exercise 1: Basic Call Flow</h4>
        <p>1. Go to the Interactive Demo tab</p>
        <p>2. Register as a user (e.g., "alice")</p>
        <p>3. Make a call to another user (e.g., "bob")</p>
        <p>4. Observe the SIP message flow in the Call Flow tab</p>
        <p>5. Hang up the call</p>
      </div>

      <div class="exercise">
        <h4>Exercise 2: Analyze SIP Messages</h4>
        <p>1. Start the server: <code>npm run server</code></p>
        <p>2. Use the SIP debugger: <code>npm run debugger</code></p>
        <p>3. Make a call from the web client</p>
        <p>4. Observe the SIP messages in the debugger output</p>
        <p>5. Identify each message type and purpose</p>
      </div>

      <div class="exercise">
        <h4>Exercise 3: Codec Testing</h4>
        <p>1. Run the tests: <code>npm test</code></p>
        <p>2. Examine the G.711 encoding/decoding test</p>
        <p>3. Understand how audio compression works</p>
        <p>4. Try different audio samples</p>
      </div>
    </div>

    <div class="guide-section">
      <h3>Next Steps</h3>
      <p>After completing this guide, you should:</p>
      <ol>
        <li><strong>Understand VoIP Fundamentals:</strong> Know how SIP and RTP work</li>
        <li><strong>Analyze Call Flows:</strong> Be able to trace SIP message exchanges</li>
        <li><strong>Debug Issues:</strong> Use tools to troubleshoot problems</li>
        <li><strong>Extend Functionality:</strong> Add new features to the system</li>
      </ol>
    </div>
  </div>

  <!-- Call Flow Tab -->
  <div id="flow" class="content">
    <h2>SIP Call Flow Visualization</h2>
    <p>Watch the actual SIP messages flow between client and server in real-time! This visualization is synchronized with the Interactive Demo tab.</p>
    
    <div id="callFlow" class="call-flow">
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üí</div>
        <div class="message pending" id="register">REGISTER</div>
        <div class="arrow">‚Üí</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üê</div>
        <div class="message pending" id="register-ok">200 OK</div>
        <div class="arrow">‚Üê</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üí</div>
        <div class="message pending" id="invite">INVITE</div>
        <div class="arrow">‚Üí</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üê</div>
        <div class="message pending" id="trying">100 Trying</div>
        <div class="arrow">‚Üê</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üê</div>
        <div class="message pending" id="ringing">180 Ringing</div>
        <div class="arrow">‚Üê</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üê</div>
        <div class="message pending" id="ok">200 OK</div>
        <div class="arrow">‚Üê</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üí</div>
        <div class="message pending" id="ack">ACK</div>
        <div class="arrow">‚Üí</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üí</div>
        <div class="message pending" id="bye">BYE</div>
        <div class="arrow">‚Üí</div>
        <div class="server">Server</div>
      </div>
      <div class="flow-line">
        <div class="client">Client</div>
        <div class="arrow">‚Üê</div>
        <div class="message pending" id="bye-ok">200 OK</div>
        <div class="arrow">‚Üê</div>
        <div class="server">Server</div>
      </div>
    </div>

    <div class="exercise">
      <h4>How to Use This Visualization</h4>
      <p>1. Go to the Interactive Demo tab</p>
      <p>2. Register a user and make a call</p>
      <p>3. Watch the messages light up in real-time:</p>
      <ul>
        <li><span style="background: #fff3e0;">Gray</span> = Pending</li>
        <li><span style="background: #c8e6c9;">Green</span> = Sent ‚úì</li>
        <li><span style="background: #2196f3;">Blue</span> = Received ‚úì</li>
      </ul>
      <p>4. Observe the timing and sequence of SIP messages</p>
    </div>
  </div>

  <!-- Why use VoIP Tab -->
  <div id="why" class="content">
    <h2>ü§î Why use VoIP?</h2>
    <p class="highlight" style="background: #e3f2fd; padding: 1em; border-radius: 4px; margin-bottom: 2em;">
      <strong>From Alexander Graham Bell to Zoom: The Evolution of Voice Communication</strong><br>
      Discover how we moved from traditional phone lines to internet-based calling and why VoIP has become the standard for modern business communication.
    </p>
    
    <div class="guide-section">
      <h3>üìû The History of Telephony</h3>
      
      <h4>The Traditional PSTN Era (1876-2000s)</h4>
      <p>The Public Switched Telephone Network (PSTN) has been the backbone of voice communication for over a century:</p>
      
      <div class="code-block">
        <strong>1876:</strong> Alexander Graham Bell patents the telephone
        <strong>1891:</strong> First automatic telephone exchange (Strowger switch)
        <strong>1960s:</strong> Digital switching systems introduced
        <strong>1980s:</strong> ISDN (Integrated Services Digital Network) launched
        <strong>1990s:</strong> Mobile cellular networks become widespread
      </div>
      
      <h4>How PSTN Works</h4>
      <ul>
        <li><strong>Circuit-Switched:</strong> Dedicated physical connection for each call</li>
        <li><strong>Copper Wires:</strong> Traditional phone lines use copper infrastructure</li>
        <li><strong>Central Offices:</strong> Physical switching centers route calls</li>
        <li><strong>Limited Features:</strong> Basic calling, voicemail, caller ID</li>
        <li><strong>High Costs:</strong> Expensive long-distance and international calls</li>
      </ul>
    </div>

    <div class="guide-section">
      <h3>üåê The Internet Revolution</h3>
      
      <h4>The Rise of IP Networks (1990s-Present)</h4>
      <p>As the internet became ubiquitous, voice communication began migrating to IP networks:</p>
      
      <div class="code-block">
        <strong>1995:</strong> First VoIP software (VocalTec Internet Phone)
        <strong>1999:</strong> SIP (Session Initiation Protocol) standardized
        <strong>2003:</strong> Skype launches, popularizing VoIP
        <strong>2007:</strong> iPhone launches, mobile VoIP begins
        <strong>2010s:</strong> Cloud-based VoIP services emerge
        <strong>2020s:</strong> VoIP becomes standard for business communication
      </div>
      
      <h4>Why IP Networks Won</h4>
      <ul>
        <li><strong>Packet-Switched:</strong> Efficient use of network bandwidth</li>
        <li><strong>Global Infrastructure:</strong> Leverages existing internet backbone</li>
        <li><strong>Cost-Effective:</strong> Much cheaper than traditional phone lines</li>
        <li><strong>Feature-Rich:</strong> Easy to add new capabilities</li>
        <li><strong>Scalable:</strong> Can handle millions of concurrent calls</li>
      </ul>
    </div>

    <div class="guide-section">
      <h3>üíº Modern VoIP Solutions</h3>
      
      <h4>Zoom Phone</h4>
      <div class="exercise">
        <p><strong>Zoom Phone</strong> represents the modern evolution of VoIP for business:</p>
        <ul>
          <li><strong>Cloud-Native:</strong> Built on Zoom's global cloud infrastructure</li>
          <li><strong>Unified Communications:</strong> Integrates video, voice, chat, and meetings</li>
          <li><strong>Global Reach:</strong> Available in 40+ countries with local phone numbers</li>
          <li><strong>Advanced Features:</strong> Call recording, analytics, auto-attendant, call routing</li>
          <li><strong>Mobile-First:</strong> Works seamlessly across desktop, mobile, and conference rooms</li>
          <li><strong>Security:</strong> Enterprise-grade encryption and compliance (HIPAA, SOC 2, etc.)</li>
        </ul>
        <p><em>"Zoom Phone has transformed how businesses communicate, combining the reliability of traditional telephony with the flexibility of modern cloud technology."</em></p>
      </div>
      
      <h4>Mitel</h4>
      <div class="exercise">
        <p><strong>Mitel</strong> is a pioneer in business communications with decades of experience:</p>
        <ul>
          <li><strong>Hybrid Solutions:</strong> On-premises, cloud, and hybrid deployment options</li>
          <li><strong>Enterprise Focus:</strong> Designed for large organizations and contact centers</li>
          <li><strong>Integration Ecosystem:</strong> Connects with CRM, ERP, and business applications</li>
          <li><strong>Contact Center:</strong> Advanced call center features and analytics</li>
          <li><strong>Global Presence:</strong> Serving 100+ countries with local support</li>
          <li><strong>Compliance:</strong> Meets industry-specific regulatory requirements</li>
        </ul>
        <p><em>"Mitel's solutions bridge the gap between legacy systems and modern cloud communications, helping enterprises transition smoothly to VoIP."</em></p>
      </div>
    </div>

    <div class="guide-section">
      <h3>üìä VoIP vs PSTN Comparison</h3>
      
      <table style="width: 100%; border-collapse: collapse; margin: 1em 0;">
        <tr style="background: #f8f9fa;">
          <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Feature</th>
          <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Traditional PSTN</th>
          <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Modern VoIP</th>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Infrastructure</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Dedicated copper lines</td>
          <td style="border: 1px solid #ddd; padding: 12px;">Internet/network connection</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Cost</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">High per-minute rates</td>
          <td style="border: 1px solid #ddd; padding: 12px;">Low flat-rate pricing</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Scalability</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Limited by physical lines</td>
          <td style="border: 1px solid #ddd; padding: 12px;">Unlimited virtual lines</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Features</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Basic calling only</td>
          <td style="border: 1px solid #ddd; padding: 12px;">Rich feature set</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Mobility</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Fixed location</td>
          <td style="border: 1px solid #ddd; padding: 12px;">Work from anywhere</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Integration</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Limited</td>
          <td style="border: 1px solid #ddd; padding: 12px;">Extensive APIs</td>
        </tr>
      </table>
    </div>

    <div class="guide-section">
      <h3>üöÄ Key Benefits of VoIP</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2em; margin: 1em 0;">
        <div class="exercise">
          <h4>üí∞ Cost Savings</h4>
          <ul>
            <li><strong>50-90% reduction</strong> in long-distance costs</li>
            <li><strong>Elimination</strong> of separate phone and internet bills</li>
            <li><strong>Free calls</strong> between company locations</li>
            <li><strong>Reduced hardware</strong> and maintenance costs</li>
          </ul>
        </div>
        
        <div class="exercise">
          <h4>üåç Global Reach</h4>
          <ul>
            <li><strong>Local numbers</strong> in multiple countries</li>
            <li><strong>International calling</strong> at local rates</li>
            <li><strong>Remote work</strong> from anywhere</li>
            <li><strong>Global teams</strong> with unified communications</li>
          </ul>
        </div>
        
        <div class="exercise">
          <h4>‚ö° Advanced Features</h4>
          <ul>
            <li><strong>Auto-attendant</strong> and call routing</li>
            <li><strong>Call recording</strong> and analytics</li>
            <li><strong>Video calling</strong> integration</li>
            <li><strong>CRM integration</strong> and call tracking</li>
          </ul>
        </div>
        
        <div class="exercise">
          <h4>üîß Easy Management</h4>
          <ul>
            <li><strong>Web-based</strong> administration</li>
            <li><strong>Instant scaling</strong> up or down</li>
            <li><strong>Real-time</strong> monitoring and reporting</li>
            <li><strong>Automatic updates</strong> and maintenance</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="guide-section">
      <h3>üìà The Future of Voice Communication</h3>
      
      <h4>Emerging Trends</h4>
      <ul>
        <li><strong>5G Integration:</strong> Ultra-low latency voice over 5G networks</li>
        <li><strong>AI-Powered Features:</strong> Voice analytics, sentiment analysis, automated transcription</li>
        <li><strong>WebRTC:</strong> Browser-based calling without plugins</li>
        <li><strong>IoT Integration:</strong> Voice control for smart devices</li>
        <li><strong>Edge Computing:</strong> Reduced latency through distributed processing</li>
      </ul>
      
      <h4>Industry Adoption</h4>
      <p>VoIP adoption continues to accelerate across all sectors:</p>
      <ul>
        <li><strong>Healthcare:</strong> HIPAA-compliant VoIP for telemedicine</li>
        <li><strong>Education:</strong> Virtual classrooms and remote learning</li>
        <li><strong>Finance:</strong> Secure voice communication for trading floors</li>
        <li><strong>Government:</strong> Cost-effective communication for public services</li>
        <li><strong>Retail:</strong> Unified communications for customer service</li>
      </ul>
    </div>

    <div class="exercise" style="background: #e8f5e8; padding: 1.5em; border-left: 4px solid #28a745; margin: 2em 0;">
      <h4>üéØ Why VoIP Matters Today</h4>
      <p><strong>VoIP has become the standard for modern business communication</strong> because it offers the perfect combination of cost-effectiveness, flexibility, and advanced features. Whether you're using Zoom Phone for seamless video-voice integration or Mitel for enterprise-grade reliability, VoIP represents the future of how we connect.</p>
      <p>As we continue to move toward a more connected, remote-friendly world, understanding VoIP technology becomes increasingly important for anyone working in technology, business, or communications.</p>
    </div>
  </div>

  <!-- VoIP Security Tab -->
  <div id="security" class="content">
    <h2>üîí VoIP Security</h2>
    <p class="highlight" style="background: #fff3cd; padding: 1em; border-radius: 4px; margin-bottom: 2em;">
      <strong>Protecting Voice Communications in the Digital Age</strong><br>
      VoIP introduces unique security challenges that don't exist in traditional telephony. Understanding these threats and implementing proper security measures is essential for any VoIP deployment.
    </p>
    
    <div class="guide-section">
      <h3>üö® Common VoIP Security Threats</h3>
      
      <h4>1. Eavesdropping & Call Interception</h4>
      <div class="exercise">
        <p><strong>Threat:</strong> Attackers can intercept and listen to VoIP calls by capturing RTP packets.</p>
        <ul>
          <li><strong>Packet Sniffing:</strong> Using tools like Wireshark to capture unencrypted RTP streams</li>
          <li><strong>Man-in-the-Middle:</strong> Intercepting calls between endpoints</li>
          <li><strong>Network Monitoring:</strong> ISP or network administrator access to call data</li>
        </ul>
        <div class="code-block">
Example: Unencrypted RTP packet capture
RTP Header: [Version=2, PT=0, Seq=1234, Timestamp=5678]
Payload: [Raw audio data - easily decoded to voice]
        </div>
      </div>
      
      <h4>2. Call Hijacking & Spoofing</h4>
      <div class="exercise">
        <p><strong>Threat:</strong> Attackers can impersonate legitimate users or redirect calls.</p>
        <ul>
          <li><strong>SIP Identity Spoofing:</strong> Forging caller ID and SIP headers</li>
          <li><strong>Call Diversion:</strong> Redirecting calls to unauthorized numbers</li>
          <li><strong>Registration Hijacking:</strong> Taking control of user registrations</li>
        </ul>
        <div class="code-block">
Malicious SIP INVITE:
INVITE sip:ceo@company.com SIP/2.0
From: &lt;sip:attacker@evil.com&gt;
To: &lt;sip:ceo@company.com&gt;
Call-ID: fake-call-id@evil.com
        </div>
      </div>
      
      <h4>3. Denial of Service (DoS) Attacks</h4>
      <div class="exercise">
        <p><strong>Threat:</strong> Overwhelming VoIP systems to disrupt service.</p>
        <ul>
          <li><strong>SIP Flooding:</strong> Sending massive volumes of SIP messages</li>
          <li><strong>RTP Bombing:</strong> Flooding with fake RTP packets</li>
          <li><strong>Registration Flooding:</strong> Exhausting server resources</li>
        </ul>
      </div>
      
      <h4>4. Toll Fraud & Call Abuse</h4>
      <div class="exercise">
        <p><strong>Threat:</strong> Unauthorized use of VoIP systems for expensive calls.</p>
        <ul>
          <li><strong>International Call Fraud:</strong> Making expensive overseas calls</li>
          <li><strong>Premium Number Dialing:</strong> Calling expensive premium services</li>
          <li><strong>Credential Theft:</strong> Stealing SIP credentials for abuse</li>
        </ul>
      </div>
    </div>

    <div class="guide-section">
      <h3>üõ°Ô∏è Security Solutions & Best Practices</h3>
      
      <h4>1. Encryption & Secure Protocols</h4>
      <div class="exercise">
        <h5>SRTP (Secure Real-time Transport Protocol)</h5>
        <p>Encrypts RTP media streams to prevent eavesdropping:</p>
        <ul>
          <li><strong>AES Encryption:</strong> 128-bit or 256-bit encryption for audio data</li>
          <li><strong>Message Authentication:</strong> HMAC-SHA1 for packet integrity</li>
          <li><strong>Replay Protection:</strong> Prevents packet replay attacks</li>
        </ul>
        <div class="code-block">
SRTP Packet Structure:
[SRTP Header] + [Encrypted Audio Payload] + [Authentication Tag]
Encryption: AES-128-GCM
Authentication: HMAC-SHA1
        </div>
      </div>
      
      <div class="exercise">
        <h5>SIPS (SIP over TLS)</h5>
        <p>Encrypts SIP signaling messages:</p>
        <ul>
          <li><strong>TLS 1.2/1.3:</strong> Transport Layer Security for SIP</li>
          <li><strong>Certificate Validation:</strong> Verify server identities</li>
          <li><strong>End-to-End Security:</strong> Protects signaling from eavesdropping</li>
        </ul>
        <div class="code-block">
SIPS URI Example:
sips:user@domain.com:5061
TLS Certificate: Validates server identity
        </div>
      </div>
      
      <h4>2. Authentication & Authorization</h4>
      <div class="exercise">
        <h5>Strong Authentication Methods</h5>
        <ul>
          <li><strong>Digest Authentication:</strong> Challenge-response authentication</li>
          <li><strong>Certificate-Based:</strong> X.509 certificates for device authentication</li>
          <li><strong>Multi-Factor Authentication:</strong> SMS, email, or app-based 2FA</li>
          <li><strong>Biometric Authentication:</strong> Fingerprint or voice recognition</li>
        </ul>
        <div class="code-block">
SIP Digest Authentication:
WWW-Authenticate: Digest realm="sip.company.com",
                  nonce="abc123",
                  algorithm=MD5
Authorization: Digest username="user",
              realm="sip.company.com",
              nonce="abc123",
              response="calculated_hash"
        </div>
      </div>
      
      <h4>3. Network Security</h4>
      <div class="exercise">
        <h5>Network Protection Measures</h5>
        <ul>
          <li><strong>VLAN Segmentation:</strong> Isolate VoIP traffic from data networks</li>
          <li><strong>Firewall Rules:</strong> Restrict SIP/RTP traffic to authorized sources</li>
          <li><strong>Intrusion Detection:</strong> Monitor for suspicious VoIP activity</li>
          <li><strong>Quality of Service (QoS):</strong> Prioritize VoIP traffic</li>
        </ul>
        <div class="code-block">
Firewall Rules Example:
# Allow SIP signaling
iptables -A INPUT -p udp --dport 5060 -s 192.168.1.0/24 -j ACCEPT
# Allow RTP media
iptables -A INPUT -p udp --dport 10000:20000 -s 192.168.1.0/24 -j ACCEPT
        </div>
      </div>
    </div>

    <div class="guide-section">
      <h3>üîê Advanced Security Features</h3>
      
      <h4>1. End-to-End Encryption (E2EE)</h4>
      <div class="exercise">
        <p><strong>Signal Protocol & ZRTP:</strong> Advanced encryption for maximum privacy</p>
        <ul>
          <li><strong>Perfect Forward Secrecy:</strong> Each call uses unique encryption keys</li>
          <li><strong>Key Exchange:</strong> Diffie-Hellman key agreement</li>
          <li><strong>Verification:</strong> Short authentication strings (SAS)</li>
          <li><strong>No Metadata:</strong> Minimal call metadata collection</li>
        </ul>
        <div class="code-block">
ZRTP Key Exchange:
1. DH1: Initial key exchange
2. DH2: Confirm key agreement
3. Confirm: SAS verification
4. Secure: Encrypted media flow
        </div>
      </div>
      
      <h4>2. Call Recording Security</h4>
      <div class="exercise">
        <p><strong>Secure Recording Practices:</strong> Protecting recorded calls</p>
        <ul>
          <li><strong>Encrypted Storage:</strong> AES-256 encryption for recordings</li>
          <li><strong>Access Controls:</strong> Role-based permissions for playback</li>
          <li><strong>Audit Logging:</strong> Track who accessed recordings</li>
          <li><strong>Retention Policies:</strong> Automatic deletion after specified time</li>
        </ul>
      </div>
      
      <h4>3. Compliance & Regulatory Requirements</h4>
      <div class="exercise">
        <h5>Industry-Specific Requirements</h5>
        <ul>
          <li><strong>HIPAA (Healthcare):</strong> Patient data protection in telemedicine</li>
          <li><strong>PCI DSS (Finance):</strong> Payment card data security</li>
          <li><strong>SOX (Public Companies):</strong> Financial reporting compliance</li>
          <li><strong>GDPR (EU):</strong> Personal data protection</li>
        </ul>
      </div>
    </div>

    <div class="guide-section">
      <h3>üö® Security Monitoring & Incident Response</h3>
      
      <h4>1. Real-Time Monitoring</h4>
      <div class="exercise">
        <h5>Security Monitoring Tools</h5>
        <ul>
          <li><strong>SIP Monitoring:</strong> Detect unusual call patterns</li>
          <li><strong>Traffic Analysis:</strong> Monitor bandwidth and packet flows</li>
          <li><strong>Anomaly Detection:</strong> AI-powered threat detection</li>
          <li><strong>Log Analysis:</strong> Centralized logging and correlation</li>
        </ul>
        <div class="code-block">
Security Alert Example:
ALERT: Unusual call volume detected
- 50 calls in 1 minute from single IP
- Multiple failed authentication attempts
- Calls to premium rate numbers
Action: Block IP, investigate credentials
        </div>
      </div>
      
      <h4>2. Incident Response Plan</h4>
      <div class="exercise">
        <h5>VoIP Security Incident Response</h5>
        <ol>
          <li><strong>Detection:</strong> Identify security incident</li>
          <li><strong>Containment:</strong> Isolate affected systems</li>
          <li><strong>Investigation:</strong> Analyze attack vectors and scope</li>
          <li><strong>Remediation:</strong> Fix vulnerabilities and restore service</li>
          <li><strong>Recovery:</strong> Return to normal operations</li>
          <li><strong>Lessons Learned:</strong> Update security measures</li>
        </ol>
      </div>
    </div>

    <div class="guide-section">
      <h3>üìä Security Assessment Checklist</h3>
      
      <table style="width: 100%; border-collapse: collapse; margin: 1em 0;">
        <tr style="background: #f8f9fa;">
          <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Security Area</th>
          <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Checklist Item</th>
          <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">Status</th>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Encryption</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">SRTP enabled for all calls</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Encryption</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">SIPS/TLS for signaling</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Authentication</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Strong password policies</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Authentication</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Multi-factor authentication</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Network</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">VoIP traffic isolated (VLAN)</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Network</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Firewall rules configured</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Monitoring</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Security monitoring enabled</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Monitoring</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Incident response plan</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Compliance</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Industry regulations met</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
        <tr>
          <td style="border: 1px solid #ddd; padding: 12px;"><strong>Compliance</strong></td>
          <td style="border: 1px solid #ddd; padding: 12px;">Regular security audits</td>
          <td style="border: 1px solid #ddd; padding: 12px; text-align: center;">‚òê</td>
        </tr>
      </table>
    </div>

    <div class="exercise" style="background: #e8f5e8; padding: 1.5em; border-left: 4px solid #28a745; margin: 2em 0;">
      <h4>üîí Security-First VoIP Design</h4>
      <p><strong>VoIP security is not optional</strong> - it's essential for protecting sensitive communications in today's digital world. By implementing encryption, strong authentication, network segmentation, and continuous monitoring, organizations can enjoy the benefits of VoIP while maintaining the highest levels of security.</p>
      <p>Remember: <em>"Security is a process, not a product."</em> Regular assessment, updates, and training are crucial for maintaining a secure VoIP environment.</p>
    </div>
  </div>

  <!-- Footer -->
  <footer style="background: #2c3e50; color: white; padding: 2em; margin-top: 3em; text-align: center;">
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1em;">
        <div style="text-align: left;">
          <h4 style="margin: 0 0 0.5em 0; color: #3498db;">üé§ VoIP Learning Platform</h4>
          <p style="margin: 0; font-size: 0.9em; opacity: 0.8;">
            Interactive Voice over IP demonstration and learning tool
          </p>
        </div>
        
        <div style="text-align: center;">
          <p style="margin: 0; font-size: 0.9em;">
            Built with ‚ù§Ô∏è for VoIP education
          </p>
          <p style="margin: 0.5em 0 0 0; font-size: 0.8em; opacity: 0.7;">
            SIP ‚Ä¢ RTP ‚Ä¢ G.711 ‚Ä¢ WebRTC ‚Ä¢ Node.js
          </p>
        </div>
        
        <div style="text-align: right;">
          <p style="margin: 0; font-size: 0.9em;">
            ¬© 2024 Matt C. All rights reserved.
          </p>
          <p style="margin: 0.5em 0 0 0; font-size: 0.8em; opacity: 0.7;">
            <a href="https://github.com/pythagoras-19/voip-demo" target="_blank" style="color: #3498db; text-decoration: none;">View on GitHub</a>
          </p>
        </div>
      </div>
      
      <div style="border-top: 1px solid #34495e; margin-top: 1.5em; padding-top: 1em; font-size: 0.8em; opacity: 0.6;">
        <p style="margin: 0;">
          This educational tool demonstrates VoIP protocols including SIP signaling, RTP media streaming, and audio codecs. 
          Use responsibly and in accordance with applicable laws and regulations.
        </p>
      </div>
    </div>
  </footer>

  <script>
    let registered = false;
    let inCall = false;
    let callStep = 0;
    
    // Audio variables
    let audioContext;
    let microphone;
    let audioStream;
    let isMicrophoneEnabled = false;
    let isAudioEnabled = false;
    let audioAnalyser;
    let dataArray;
    let animationId;
    let rtpSequenceNumber = 0;
    let rtpTimestamp = 0;
    let packetsSent = 0;
    let packetsReceived = 0;
    let lastPacketTime = 0;
    let packetLoss = 0;
    let jitter = 0;
    let currentCodec = 'g711';
    let volume = 0.5;
    
    // Audio codec bitrates
    const codecBitrates = {
      g711: 64,
      g729: 8,
      opus: 32
    };
    
    function showTab(tabName) {
      // Hide all content
      document.querySelectorAll('.content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected content and activate tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }
    
    function log(msg) {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${timestamp}] ${msg}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function setStatus(msg) {
      document.getElementById('status').textContent = msg;
    }
    
    function updateMessage(id, status) {
      const msg = document.getElementById(id);
      if (msg) {
        msg.className = `message ${status}`;
        if (status === 'sent') {
          msg.innerHTML = msg.textContent + ' ‚úì';
        } else if (status === 'received') {
          msg.innerHTML = msg.textContent + ' ‚úì';
        }
      }
      
      // Also update the original call flow tab if it exists
      const originalMsg = document.getElementById(id.replace('demo-', ''));
      if (originalMsg) {
        originalMsg.className = `message ${status}`;
        if (status === 'sent') {
          originalMsg.innerHTML = originalMsg.textContent + ' ‚úì';
        } else if (status === 'received') {
          originalMsg.innerHTML = originalMsg.textContent + ' ‚úì';
        }
      }
    }
    
    function resetDemoCallFlow() {
      ['demo-register', 'demo-register-ok', 'demo-invite', 'demo-trying', 'demo-ringing', 'demo-ok', 'demo-ack', 'demo-bye', 'demo-bye-ok'].forEach(id => {
        updateMessage(id, 'pending');
      });
    }
    
    // Audio Functions
    async function toggleMicrophone() {
      if (!isMicrophoneEnabled) {
        try {
          audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          microphone = audioContext.createMediaStreamSource(audioStream);
          audioAnalyser = audioContext.createAnalyser();
          audioAnalyser.fftSize = 256;
          
          microphone.connect(audioAnalyser);
          dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
          
          isMicrophoneEnabled = true;
          document.getElementById('micButton').textContent = 'üé§ Disable Microphone';
          document.getElementById('micButton').style.background = '#27ae60';
          document.getElementById('audioButton').disabled = false;
          
          log('Microphone enabled - Audio capture started');
          startAudioVisualization();
        } catch (error) {
          log('Error accessing microphone: ' + error.message);
        }
      } else {
        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
        }
        if (audioContext) {
          audioContext.close();
        }
        isMicrophoneEnabled = false;
        document.getElementById('micButton').textContent = 'üé§ Enable Microphone';
        document.getElementById('micButton').style.background = '#e74c3c';
        document.getElementById('audioButton').disabled = true;
        isAudioEnabled = false;
        document.getElementById('audioButton').textContent = 'üîä Enable Audio';
        document.getElementById('audioButton').style.background = '#e74c3c';
        
        log('Microphone disabled');
        stopAudioVisualization();
      }
    }
    
    function toggleAudioPlayback() {
      if (!isAudioEnabled && isMicrophoneEnabled) {
        isAudioEnabled = true;
        document.getElementById('audioButton').textContent = 'üîä Disable Audio';
        document.getElementById('audioButton').style.background = '#27ae60';
        log('Audio playback enabled - RTP streaming started');
        startRTPStreaming();
      } else {
        isAudioEnabled = false;
        document.getElementById('audioButton').textContent = 'üîä Enable Audio';
        document.getElementById('audioButton').style.background = '#e74c3c';
        log('Audio playback disabled');
        stopRTPStreaming();
      }
    }
    
    function updateVolume() {
      volume = document.getElementById('volumeSlider').value / 100;
      document.getElementById('volumeValue').textContent = document.getElementById('volumeSlider').value + '%';
    }
    
    function changeCodec() {
      currentCodec = document.getElementById('codecSelect').value;
      log(`Codec changed to ${currentCodec.toUpperCase()} (${codecBitrates[currentCodec]} kbps)`);
      updateBandwidth();
    }
    
    function startAudioVisualization() {
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      
      function draw() {
        if (!isMicrophoneEnabled) return;
        
        animationId = requestAnimationFrame(draw);
        audioAnalyser.getByteTimeDomainData(dataArray);
        
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#3498db';
        ctx.beginPath();
        
        const sliceWidth = canvas.width / dataArray.length;
        let x = 0;
        let audioLevel = 0;
        
        for (let i = 0; i < dataArray.length; i++) {
          const v = dataArray[i] / 128.0;
          const y = v * canvas.height / 2;
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
          
          audioLevel += Math.abs(v - 1);
          x += sliceWidth;
        }
        
        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
        
        // Update audio level display
        const avgLevel = (audioLevel / dataArray.length) * 100;
        document.getElementById('audioLevel').textContent = `Level: ${Math.round(avgLevel)}%`;
        
        // Real frequency analysis
        const frequencyData = new Uint8Array(audioAnalyser.frequencyBinCount);
        audioAnalyser.getByteFrequencyData(frequencyData);
        
        // Find dominant frequency
        let maxIndex = 0;
        let maxValue = 0;
        for (let i = 0; i < frequencyData.length; i++) {
          if (frequencyData[i] > maxValue) {
            maxValue = frequencyData[i];
            maxIndex = i;
          }
        }
        
        // Convert bin index to frequency (assuming 44.1kHz sample rate)
        const sampleRate = audioContext.sampleRate;
        const dominantFreq = Math.round((maxIndex * sampleRate) / (audioAnalyser.fftSize * 2));
        
        // Only show frequency if there's significant audio activity
        if (avgLevel > 5) {
          document.getElementById('frequency').textContent = `Freq: ${dominantFreq} Hz`;
        } else {
          document.getElementById('frequency').textContent = 'Freq: -- Hz';
        }
      }
      
      draw();
    }
    
    function stopAudioVisualization() {
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#f8f9fa';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      document.getElementById('audioLevel').textContent = 'Level: 0%';
      document.getElementById('frequency').textContent = 'Freq: -- Hz';
    }
    
    function startRTPStreaming() {
      if (!isAudioEnabled) return;
      
      function sendRTPPacket() {
        if (!isAudioEnabled) return;
        
        const now = Date.now();
        const packetSize = Math.floor(Math.random() * 160) + 20; // 20-180 bytes
        const payload = generateAudioPayload(packetSize);
        
        // Create RTP packet
        const rtpPacket = {
          version: 2,
          padding: 0,
          extension: 0,
          csrcCount: 0,
          marker: 0,
          payloadType: getPayloadType(currentCodec),
          sequenceNumber: rtpSequenceNumber++,
          timestamp: rtpTimestamp,
          ssrc: 0x12345678,
          payload: payload,
          size: packetSize + 12 // RTP header (12 bytes) + payload
        };
        
        rtpTimestamp += 160; // 20ms at 8kHz
        packetsSent++;
        
        // Simulate packet loss (1% chance)
        if (Math.random() > 0.01) {
          packetsReceived++;
          addRTPPacketToMonitor(rtpPacket, 'received');
        } else {
          packetLoss++;
          addRTPPacketToMonitor(rtpPacket, 'lost');
        }
        
        // Calculate jitter
        if (lastPacketTime > 0) {
          const delay = now - lastPacketTime;
          jitter = jitter * 0.9 + Math.abs(delay - 20) * 0.1; // Target 20ms
        }
        lastPacketTime = now;
        
        updateStatistics();
        
        // Continue streaming
        setTimeout(sendRTPPacket, 20); // 50 packets per second
      }
      
      sendRTPPacket();
    }
    
    function stopRTPStreaming() {
      // This will stop when isAudioEnabled becomes false
    }
    
    function generateAudioPayload(size) {
      // Generate random audio-like data
      const payload = new Uint8Array(size);
      for (let i = 0; i < size; i++) {
        payload[i] = Math.floor(Math.random() * 256);
      }
      return payload;
    }
    
    function getPayloadType(codec) {
      const payloadTypes = {
        g711: 0,
        g729: 18,
        opus: 111
      };
      return payloadTypes[codec] || 0;
    }
    
    function addRTPPacketToMonitor(packet, status) {
      const monitor = document.getElementById('rtpMonitor');
      const timestamp = new Date().toLocaleTimeString();
      const statusColor = status === 'received' ? '#27ae60' : '#e74c3c';
      const statusText = status === 'received' ? '‚úì' : '‚úó';
      
      const packetInfo = `
        <div style="color: ${statusColor}; margin-bottom: 0.2em;">
          [${timestamp}] RTP ${statusText} Seq:${packet.sequenceNumber} 
          PT:${packet.payloadType} Size:${packet.size} bytes
        </div>
      `;
      
      monitor.innerHTML = packetInfo + monitor.innerHTML;
      
      // Keep only last 10 packets
      const lines = monitor.innerHTML.split('<div');
      if (lines.length > 11) {
        monitor.innerHTML = lines.slice(0, 11).join('<div');
      }
      
      // Update packet rate
      const packetRate = Math.round(packetsSent / (Date.now() - lastPacketTime) * 1000);
      document.getElementById('packetRate').textContent = `RTP: ${packetRate} pkts/s`;
    }
    
    function updateStatistics() {
      document.getElementById('packetsSent').textContent = packetsSent;
      document.getElementById('packetsReceived').textContent = packetsReceived;
      document.getElementById('packetLoss').textContent = packetsSent > 0 ? 
        Math.round((packetLoss / packetsSent) * 100) + '%' : '0%';
      document.getElementById('jitter').textContent = Math.round(jitter) + 'ms';
      updateBandwidth();
      updateMOSScore();
    }
    
    function updateBandwidth() {
      const bitrate = codecBitrates[currentCodec];
      const overhead = 0.1; // 10% overhead for RTP/UDP/IP headers
      const totalBitrate = bitrate * (1 + overhead);
      document.getElementById('bandwidth').textContent = Math.round(totalBitrate) + ' kbps';
    }
    
    function updateMOSScore() {
      // Calculate MOS based on packet loss and jitter
      let mos = 5.0;
      
      // Reduce MOS based on packet loss
      const lossRate = packetsSent > 0 ? (packetLoss / packetsSent) : 0;
      if (lossRate > 0.05) mos -= 2.0; // >5% loss
      else if (lossRate > 0.02) mos -= 1.0; // >2% loss
      else if (lossRate > 0.01) mos -= 0.5; // >1% loss
      
      // Reduce MOS based on jitter
      if (jitter > 100) mos -= 1.5; // >100ms jitter
      else if (jitter > 50) mos -= 0.8; // >50ms jitter
      else if (jitter > 20) mos -= 0.3; // >20ms jitter
      
      mos = Math.max(1.0, Math.min(5.0, mos));
      document.getElementById('mosScore').textContent = mos.toFixed(1);
    }
    
    function registerUser() {
      const username = document.getElementById('username').value;
      setStatus('Registering as ' + username + '...');
      log('Sending REGISTER request...');
      updateMessage('demo-register', 'sent');
      
      // Simulate registration response
      setTimeout(() => {
        updateMessage('demo-register-ok', 'received');
        registered = true;
        setStatus('Registered as ' + username);
        log('Received 200 OK - Registration successful');
      }, 1000);
    }
    
    function makeCall() {
      if (!registered) {
        log('Please register first.');
        return;
      }
      
      const target = document.getElementById('target').value;
      setStatus('Calling ' + target + '...');
      callStep = 0;
      
      // Reset all messages
      ['demo-invite', 'demo-trying', 'demo-ringing', 'demo-ok', 'demo-ack', 'demo-bye', 'demo-bye-ok'].forEach(id => {
        updateMessage(id, 'pending');
      });
      
      // Start call flow
      log('Sending INVITE request...');
      updateMessage('demo-invite', 'sent');
      
      setTimeout(() => {
        log('Received 100 Trying...');
        updateMessage('demo-trying', 'received');
      }, 800);
      
      setTimeout(() => {
        log('Received 180 Ringing...');
        updateMessage('demo-ringing', 'received');
      }, 1600);
      
      setTimeout(() => {
        log('Received 200 OK - Call answered!');
        updateMessage('demo-ok', 'received');
        inCall = true;
        setStatus('In call with ' + target);
        
        // Send ACK
        setTimeout(() => {
          log('Sending ACK...');
          updateMessage('demo-ack', 'sent');
        }, 500);
      }, 2400);
    }
    
    function hangupCall() {
      if (!inCall) {
        log('No active call.');
        return;
      }
      
      log('Sending BYE request...');
      updateMessage('demo-bye', 'sent');
      
      setTimeout(() => {
        log('Received 200 OK - Call ended');
        updateMessage('demo-bye-ok', 'received');
        setStatus('Call ended');
        inCall = false;
      }, 800);
    }
  </script>
</body>
</html> 